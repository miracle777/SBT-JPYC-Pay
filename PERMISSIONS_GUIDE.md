# 🎯 権限とロールの説明

## 📋 目次

1. [権限体系の概要](#権限体系の概要)
2. [ロールの詳細](#ロールの詳細)
3. [権限マトリクス](#権限マトリクス)
4. [ユースケース](#ユースケース)
5. [セキュリティモデル](#セキュリティモデル)

---

## 権限体系の概要

このSBTスタンプシステムは、**階層的な権限モデル**を採用しています:

```
┌─────────────────────────────────────┐
│     コントラクトオーナー (1名)      │ ← 最上位権限
│  - システム全体の管理者             │
│  - ショップの登録・管理             │
│  - すべてのSBT発行権限              │
└─────────────────────────────────────┘
              ↓ 登録する
┌─────────────────────────────────────┐
│     ショップオーナー (複数)         │ ← 中間権限
│  - 自分のショップIDでSBT発行       │
│  - 顧客にスタンプ付与               │
│  - 店舗独自のテンプレート作成       │
└─────────────────────────────────────┘
              ↓ SBT発行
┌─────────────────────────────────────┐
│     ユーザー (顧客)                │ ← 受益者
│  - SBTを受け取る                   │
│  - スタンプを貯める                 │
│  - 特典を受け取る                   │
└─────────────────────────────────────┘
```

---

## ロールの詳細

### 1. 👑 コントラクトオーナー

**定義:**
- SBTスマートコントラクトをデプロイしたウォレットアドレス
- システム全体の最高管理者
- **通常1名のみ**（プラットフォーム運営者）

**権限:**
- ✅ すべてのショップの登録・管理
- ✅ すべてのショップIDでSBT発行
- ✅ コントラクトのアップグレード（該当する場合）
- ✅ システム全体の設定変更
- ✅ ショップ管理画面へのアクセス（BASIC認証経由）

**確認方法:**
```javascript
// スマートコントラクトの owner() 関数を呼び出す
const owner = await contract.owner();
// 接続中のウォレットと比較
const isOwner = owner.toLowerCase() === walletAddress.toLowerCase();
```

**取得方法:**
- スマートコントラクトをデプロイしたウォレットが自動的にオーナーになります
- デプロイ後の変更は、コントラクトに `transferOwnership()` 関数がある場合のみ可能

---

### 2. 🏪 ショップオーナー

**定義:**
- コントラクトオーナーによって登録されたウォレットアドレス
- 特定のショップID に紐づけられた管理者
- **複数のショップオーナーが存在可能**（各店舗ごと）

**権限:**
- ✅ 自分のショップIDでSBT発行
- ✅ 顧客へのスタンプ付与
- ✅ SBTテンプレートの作成・管理（自店舗用）
- ❌ 他のショップの登録・管理（不可）
- ❌ ショップ管理画面へのアクセス（不可）

**登録方法:**
1. コントラクトオーナーがショップ管理画面にアクセス
2. 新規ショップ登録フォームに情報を入力:
   - ショップID
   - ショップ名
   - **ショップオーナーアドレス** ← ここで指定
   - 必要利用回数
3. ブロックチェーンに登録（トランザクション発行）

**確認方法:**
```javascript
// スマートコントラクトの getShopInfo() 関数を呼び出す
const shopInfo = await contract.getShopInfo(shopId);
// 接続中のウォレットと比較
const isShopOwner = shopInfo.owner.toLowerCase() === walletAddress.toLowerCase();
```

---

### 3. 👤 ユーザー (顧客)

**定義:**
- SBTを受け取るエンドユーザー
- 店舗の顧客・利用者
- **不特定多数**

**権限:**
- ✅ SBTの受け取り（ショップオーナーが発行）
- ✅ 保有SBTの確認
- ✅ スタンプの蓄積
- ✅ 特典の受け取り
- ❌ SBTの発行（不可）
- ❌ 管理画面へのアクセス（不可）

**SBT受け取り方法:**
1. ショップで商品購入・サービス利用
2. ショップオーナーが顧客のウォレットアドレスにSBTを発行
3. 顧客のウォレットにSBT（NFT）が届く
4. `/user` ページでSBTとスタンプ数を確認

---

## 権限マトリクス

| 機能 | コントラクトオーナー | ショップオーナー | ユーザー |
|-----|---------------------|-----------------|---------|
| **ショップ管理画面アクセス** | ✅ 可能 | ❌ 不可 | ❌ 不可 |
| **新規ショップ登録** | ✅ 可能 | ❌ 不可 | ❌ 不可 |
| **ショップ情報閲覧** | ✅ すべて | ✅ 自店舗のみ | ❌ 不可 |
| **SBT発行 (任意のショップID)** | ✅ 可能 | ❌ 不可 | ❌ 不可 |
| **SBT発行 (自店舗ID)** | ✅ 可能 | ✅ 可能 | ❌ 不可 |
| **SBTテンプレート作成** | ✅ 可能 | ✅ 可能 | ❌ 不可 |
| **SBT受け取り** | ✅ 可能 | ✅ 可能 | ✅ 可能 |
| **スタンプ確認** | ✅ 可能 | ✅ 可能 | ✅ 可能 |
| **コントラクト設定変更** | ✅ 可能 | ❌ 不可 | ❌ 不可 |

---

## ユースケース

### 🎬 シナリオ1: プラットフォーム運営者として複数店舗を管理

**あなた（コントラクトオーナー）の役割:**

1. SBTコントラクトをデプロイ
2. 複数の店舗をシステムに登録
3. 各店舗のオーナーにウォレットアドレスを伝える
4. システム全体を監視・管理

**手順:**

```bash
# ステップ1: コントラクトデプロイ
cd contracts
npx hardhat run deploy-mainnet.js --network polygon

# ステップ2: ショップ管理画面にアクセス
# https://your-domain.com/shop-admin

# ステップ3: 店舗Aを登録
ショップID: 1
ショップ名: カフェ ABC
オーナーアドレス: 0x1111...1111

# ステップ4: 店舗Bを登録
ショップID: 2
ショップ名: レストラン XYZ
オーナーアドレス: 0x2222...2222

# ステップ5: 各店舗オーナーに通知
```

**登録後のフロー:**

```
あなた（運営者）
  ↓ ショップA登録
カフェ ABC (ID:1, Owner: 0x1111...1111)
  ↓ SBT発行
顧客A (SBTを受け取る)

あなた（運営者）
  ↓ ショップB登録
レストラン XYZ (ID:2, Owner: 0x2222...2222)
  ↓ SBT発行
顧客B (SBTを受け取る)
```

---

### 🎬 シナリオ2: 自分の店舗専用でSBTシステムを運用

**あなた（コントラクトオーナー = ショップオーナー）の役割:**

1. SBTコントラクトをデプロイ
2. 自分のウォレットをショップID 1のオーナーとして登録
3. 顧客にSBTを発行

**手順:**

```bash
# ステップ1: コントラクトデプロイ
cd contracts
npx hardhat run deploy-mainnet.js --network polygon

# ステップ2: ショップ管理画面で自分を登録
ショップID: 1
ショップ名: 私のカフェ
オーナーアドレス: 0x5888...D8Fd (あなた自身のアドレス)

# ステップ3: SBT管理画面で顧客にSBT発行
```

**メリット:**

- シンプルな運用（1人ですべて管理）
- 追加コストなし
- 即座に開始可能

---

### 🎬 シナリオ3: 店舗オーナーとしてSBTを発行

**あなた（ショップオーナー）の役割:**

1. プラットフォーム運営者から登録された旨の連絡を受ける
2. 自分のウォレットでシステムにアクセス
3. 顧客にSBTを発行

**手順:**

```bash
# ステップ1: 運営者から受け取った情報
ショップID: 3
ショップ名: あなたの店舗名
オーナーアドレス: 0x3333...3333 (あなたのアドレス)

# ステップ2: SBT管理画面にアクセス
# https://platform-domain.com/sbt-management

# ステップ3: ウォレット接続
# MetaMaskで 0x3333...3333 に接続

# ステップ4: 権限確認
「✅ SBT発行権限OK - ショップオーナーとして...」が表示される

# ステップ5: 顧客にSBT発行
```

**制限事項:**

- ❌ 他のショップを登録できない
- ❌ ショップ管理画面にアクセスできない
- ✅ 自分のショップ(ID:3)でのみSBT発行可能

---

## セキュリティモデル

### 🔒 オンチェーン権限検証

すべての権限チェックは**スマートコントラクト上で実行**されます:

```solidity
// JpycStampSBT.sol の例

function mintSBT(
    uint256 shopId,
    address to,
    string memory tokenURI
) public {
    // ショップ情報を取得
    Shop storage shop = shops[shopId];
    
    // 権限チェック: オーナー または ショップオーナー
    require(
        msg.sender == owner() || msg.sender == shop.owner,
        "Not authorized"
    );
    
    // SBT発行処理
    _safeMint(to, nextTokenId);
    // ...
}
```

### 🛡️ フロントエンドの権限表示

UIレベルでも権限を確認して、適切な画面を表示:

```typescript
// SBTManagement.tsx の例

// コントラクトオーナーチェック
const ownerResult = await getContractOwner(chainId);
const isContractOwner = 
  ownerResult.owner?.toLowerCase() === walletAddress?.toLowerCase();

// ショップオーナーチェック
const shopResult = await getShopInfo(1, chainId);
const isShopOwner = 
  shopResult.shopInfo?.owner?.toLowerCase() === walletAddress?.toLowerCase();

// 権限に応じた表示
{isContractOwner && (
  <button onClick={() => navigate('/shop-admin')}>
    🔧 ショップ管理画面を開く
  </button>
)}

{!isContractOwner && !isShopOwner && (
  <div className="bg-red-50">
    ⚠️ SBT発行権限がありません
  </div>
)}
```

### 🔐 BASIC認証（ショップ管理画面）

追加の保護層として、ショップ管理画面は**BASIC認証**で保護:

```typescript
// ShopAdmin.tsx の例

const ADMIN_PASSWORD = import.meta.env.VITE_ADMIN_PASSWORD || 'admin123';

const handleAuth = (e: React.FormEvent) => {
  e.preventDefault();
  if (authPassword === ADMIN_PASSWORD) {
    setIsAuthenticated(true);
    sessionStorage.setItem('shop-admin-auth', 'true');
  }
};
```

**3層のセキュリティ:**

1. ✅ BASIC認証（環境変数パスワード）
2. ✅ ウォレット接続（MetaMask署名）
3. ✅ コントラクトオーナー確認（オンチェーン）

---

## よくある質問

### Q: コントラクトオーナーを変更できますか?

**A:** コントラクトに `transferOwnership()` 関数がある場合のみ可能です。現在のオーナーが新しいオーナーアドレスを指定して実行します。

```solidity
// Ownable.sol の transferOwnership 関数
function transferOwnership(address newOwner) public onlyOwner {
    require(newOwner != address(0), "New owner is zero address");
    _transferOwnership(newOwner);
}
```

### Q: 1つのウォレットで複数のショップを管理できますか?

**A:** はい、可能です。同じウォレットアドレスを複数のショップのオーナーとして登録できます。

```
ウォレット: 0x1111...1111
  ├─ ショップID 1: カフェA
  ├─ ショップID 2: カフェB
  └─ ショップID 3: カフェC
```

### Q: ショップオーナーはコントラクトオーナーになれますか?

**A:** 技術的には可能ですが、推奨されません。役割を分離することでセキュリティが向上します。

**推奨構成:**

```
コントラクトオーナー: 0xAAAA...AAAA (プラットフォーム運営者)
  ↓ 登録
ショップオーナーA: 0xBBBB...BBBB (店舗Aの担当者)
ショップオーナーB: 0xCCCC...CCCC (店舗Bの担当者)
```

### Q: ユーザーが自分でSBTを発行できますか?

**A:** いいえ、不可能です。SBT発行はコントラクトオーナーまたはショップオーナーのみが実行できます。これによりSBTの価値と信頼性が保たれます。

### Q: ショップオーナーの権限を取り消せますか?

**A:** 現在のバージョンでは、ショップ情報の更新機能が必要です。コントラクトに該当する関数がある場合、オーナーアドレスを `0x0000...0000` に変更することで実質的に無効化できます。

---

## まとめ

### 権限の階層

```
👑 コントラクトオーナー (1名)
  - システム全体の管理者
  - すべての権限を持つ
  - ショップを登録・管理できる
  
  🏪 ショップオーナー (複数)
    - 特定のショップの管理者
    - 自店舗でのみSBT発行可能
    - コントラクトオーナーが登録
    
    👤 ユーザー (顧客)
      - SBTの受益者
      - スタンプを貯める
      - 特典を受け取る
```

### セキュリティ原則

1. **最小権限の原則**: 各ロールは必要最小限の権限のみを持つ
2. **オンチェーン検証**: すべての重要な操作はスマートコントラクトで検証
3. **多層防御**: BASIC認証 + ウォレット署名 + コントラクト権限
4. **透明性**: すべての権限はブロックチェーン上で確認可能

---

## 関連ドキュメント

- [SHOP_ADMIN_GUIDE.md](./SHOP_ADMIN_GUIDE.md) - ショップ管理画面ガイド
- [README.md](./README.md) - プロジェクト概要
- [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md) - デプロイメントガイド
- [SECURITY_DEPLOYMENT_GUIDE.md](./SECURITY_DEPLOYMENT_GUIDE.md) - セキュリティガイド
