# SBT動的メタデータ対応アップデート

## 📋 実装内容

スマホ側のアプリでSBTを表示する際、固定されたハードコーディングされた情報ではなく、設定画面で設定した店舗情報とテンプレートの内容を動的に反映するように改善しました。

## ✨ 新機能・改善点

### 1. 店舗設定の管理機能
- **設定画面の拡張**: 店舗名、店舗カテゴリ、店舗説明の入力・保存機能
- **ローカルストレージ対応**: 設定した店舗情報の永続化
- **動的読み込み**: アプリ起動時に自動的に設定を読み込み

### 2. 動的SBTメタデータ生成
- **テンプレートベース**: SBTテンプレートの情報を活用
- **店舗設定連携**: 設定画面の店舗名、カテゴリ、説明を自動反映
- **準拠フォーマット**: ユーザー指定のメタデータ形式に対応

#### 生成されるメタデータ形式

```json
{
  "name": "カフェ常連客証明",
  "description": "Cafe JPYCの常連客証明SBT", 
  "image": "ipfs://...",
  "shopId": 2,
  "required_visits": 5,
  "benefits": [
    "10%割引",
    "無料ドリンクアップグレード", 
    "Wi-Fi優先接続"
  ],
  "attributes": [
    {
      "trait_type": "Shop Name",
      "value": "Cafe JPYC"
    },
    {
      "trait_type": "Shop Category",
      "value": "カフェ・飲食"
    },
    {
      "trait_type": "Required Visits", 
      "value": 5
    },
    {
      "trait_type": "Rank",
      "value": "silver"
    }
  ]
}
```

### 3. 自動ランク決定機能
必要訪問回数に応じて自動的にランクを決定：
- **bronze**: 1-9回
- **silver**: 10-19回
- **gold**: 20-49回
- **platinum**: 50回以上

### 4. 特典リストの自動生成
- テンプレートの報酬説明から特典配列を自動生成
- カンマ、改行、「・」区切りに対応
- 複数特典の適切な配列化

### 5. ショップID動的利用
- ハードコーディングされていたshopId=1を削除
- テンプレートで設定されたshopIdを動的利用
- 各テンプレートに固有のshopIdを自動割り当て

## 🔧 技術的改善

### 新しいファイル
- `src/utils/shopSettings.ts`: 店舗設定管理ユーティリティ

### 修正されたファイル
1. **Settings.tsx**: 店舗設定UI、保存・読み込み機能追加
2. **pinata.ts**: 動的メタデータ生成メソッド追加
3. **SBTManagement.tsx**: 動的メタデータ利用、ショップID修正
4. **types/index.ts**: SBTMetadata型の拡張

### 実装パターン
- 設定値の永続化（localStorage）
- 型安全な設定管理
- フォールバック値の適切な処理
- 動的属性生成

## 📱 使用方法

### 1. 店舗設定
1. 「設定」画面を開く
2. 店舗情報セクションで以下を入力：
   - 店舗名
   - 店舗カテゴリ
   - 店舗説明
3. 「保存」ボタンをクリック

### 2. SBT発行
1. SBT管理画面でテンプレートを選択
2. SBT発行時に自動的に店舗設定が反映される
3. 動的メタデータがIPFSにアップロードされる
4. ブロックチェーンに正しいshopIdでSBTが記録される

## ⚠️ 注意点

### アップグレード手順
1. 既存の店舗設定がない場合はデフォルト値が使用される
2. 設定画面で店舗情報を一度入力・保存することを推奨
3. 既存のテンプレートは自動的に新しいshopIdを持つ

### 互換性
- 既存のSBTには影響なし
- 新しく作成されるSBTのみ動的メタデータを利用
- 設定未入力時はデフォルト値で安全に動作

## 🎯 効果

1. **一貫性の向上**: 設定画面の店舗名がSBTメタデータにも反映
2. **柔軟性の向上**: テンプレート追加・削除時の動的対応
3. **メンテナンス性**: ハードコーディング削除による保守性向上
4. **拡張性**: 新しい店舗属性の追加が容易
5. **ユーザビリティ**: 設定一元管理による使いやすさ向上

この改善により、スマホアプリで表示されるSBT情報が常に最新の店舗設定を反映し、一般配布時の店舗情報変更にも動的に対応できるようになりました。