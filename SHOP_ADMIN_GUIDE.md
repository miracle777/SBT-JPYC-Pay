# 🏪 ショップ管理画面ガイド

## 📋 目次

1. [概要](#概要)
2. [アクセス方法](#アクセス方法)
3. [BASIC認証の設定](#basic認証の設定)
4. [機能説明](#機能説明)
5. [ショップ登録手順](#ショップ登録手順)
6. [セキュリティ](#セキュリティ)
7. [トラブルシューティング](#トラブルシューティング)

---

## 概要

**ショップ管理画面**は、コントラクトオーナー専用の管理インターフェースです。

### 主な機能

- ✅ 新しいショップをシステムに登録
- ✅ 登録済みショップの一覧表示
- ✅ ショップ統計情報の確認
- ✅ ショップオーナーの権限管理

### アクセス条件

以下の**すべて**を満たす必要があります:

1. **BASIC認証**: 正しい管理者パスワードを入力
2. **ウォレット接続**: MetaMaskなどのウォレットを接続
3. **コントラクトオーナー権限**: 接続されたウォレットがSBTコントラクトのオーナーアドレスと一致

---

## アクセス方法

### 1. SBT管理画面からアクセス

1. `/sbt-management` ページにアクセス
2. ウォレットを接続（Polygon Mainnet または Amoy Testnet）
3. 「✅ SBT発行権限OK」セクションが表示される（コントラクトオーナーのみ）
4. 「🔧 ショップ管理画面を開く」ボタンをクリック

### 2. 直接URLでアクセス

```
https://your-domain.com/shop-admin
```

---

## BASIC認証の設定

### 環境変数の設定

`.env` ファイルに管理者パスワードを設定します:

```env
# ショップ管理画面のBASIC認証パスワード
VITE_ADMIN_PASSWORD=your-secure-password-here
```

### パスワード変更手順

1. プロジェクトルートの `.env` ファイルを編集
2. `VITE_ADMIN_PASSWORD` の値を変更
3. 変更を保存
4. アプリケーションを再ビルド
5. Vercelなどにデプロイ時は、環境変数を設定

### Vercelでの環境変数設定

1. Vercelダッシュボードにログイン
2. プロジェクトを選択
3. **Settings** → **Environment Variables** へ移動
4. 以下を追加:
   - **Key**: `VITE_ADMIN_PASSWORD`
   - **Value**: あなたの強力なパスワード
   - **Environment**: Production, Preview, Development すべて選択
5. **Save** をクリック
6. プロジェクトを再デプロイ

---

## 機能説明

### 📊 統計ダッシュボード

登録されたショップの統計情報を表示:

- **登録済みショップ**: システムに登録されているショップの総数
- **有効なショップ**: 現在アクティブなショップの数
- **ショップオーナー**: ユニークなオーナーアドレスの数

### 🆕 新規ショップ登録

新しいショップをシステムに追加します。

**必須項目:**

| 項目 | 説明 | 例 |
|-----|------|---|
| ショップID | 1以上の整数（重複不可） | `1`, `2`, `3` |
| ショップ名 | 店舗の名称 | `カフェ ABC` |
| ショップオーナーアドレス | SBTを発行できるウォレットアドレス | `0x1234...5678` |

**オプション項目:**

| 項目 | 説明 | デフォルト |
|-----|------|-----------|
| 説明 | ショップの詳細説明 | `{ショップ名}のSBTシステム` |
| 必要利用回数 | SBT発行に必要な利用回数 | `10` |

### 📋 ショップ一覧

登録済みのショップをカード形式で表示:

- ショップ名とID
- 有効/無効ステータス
- オーナーアドレス
- 必要利用回数

---

## ショップ登録手順

### ステップ1: 管理画面にアクセス

1. `/shop-admin` にアクセス
2. BASIC認証パスワードを入力
3. コントラクトオーナーのウォレットで接続

### ステップ2: 新規登録フォームを開く

「➕ 新しいショップを登録」ボタンをクリック

### ステップ3: 情報を入力

```
ショップID: 1
ショップ名: カフェ ABC
説明: 池袋のおしゃれカフェ
ショップオーナーアドレス: 0x1234567890abcdef1234567890abcdef12345678
必要利用回数: 10
```

### ステップ4: 登録実行

1. 「✅ 登録する」ボタンをクリック
2. MetaMaskでトランザクションを承認
3. トランザクションが確認されるまで待機（約2〜10秒）
4. 成功メッセージ「✅ ショップ "カフェ ABC" を登録しました」を確認

### ステップ5: 確認

- ページがリロードされ、新しいショップがリストに表示されます
- ショップオーナーに登録したアドレスを連絡してください

---

## ショップオーナーへの案内

ショップを登録したら、ショップオーナーに以下を伝えてください:

### 📧 ショップオーナー向け案内テンプレート

```
【SBTスタンプシステム登録完了のお知らせ】

ショップ名: [ショップ名]
ショップID: [ID番号]

貴店のSBTスタンプシステムへの登録が完了しました。

■ SBT発行方法:

1. https://your-domain.com/sbt-management にアクセス
2. 以下のウォレットアドレスで接続:
   [ショップオーナーアドレス]
3. 「✅ SBT発行権限OK」が表示されることを確認
4. SBT発行セクションから顧客にSBTを発行できます

■ ネットワーク:
- Polygon Mainnet (Chain ID: 137)

■ 必要なもの:
- MetaMaskなどのウォレット
- ガス代用のわずかなPOL（0.01 POL程度）

ご不明な点がございましたら、お気軽にお問い合わせください。
```

---

## セキュリティ

### 🔒 アクセス制限の仕組み

ショップ管理画面は**3段階のセキュリティ**で保護されています:

#### 1. BASIC認証（第1層）

- セッションベースの簡易認証
- ブラウザのセッションストレージに保存
- ログアウトすると再度パスワード入力が必要

#### 2. ウォレット接続（第2層）

- MetaMaskなどのウォレットで署名
- ブロックチェーンネットワークへの接続を確認

#### 3. スマートコントラクト権限確認（第3層）

- コントラクトの `owner()` 関数を呼び出し
- 接続されたウォレットがオーナーかチェック
- 一致しない場合、アクセス拒否画面を表示

### ⚠️ セキュリティ上の注意

1. **パスワードを強力にする**
   ```
   ❌ 弱い: admin123
   ✅ 強い: xK9$mP#vL2@qR8nT
   ```

2. **環境変数を公開しない**
   - `.env` ファイルを GitHub にコミットしない
   - `.gitignore` に `.env` が含まれているか確認

3. **本番環境でパスワードを変更**
   - `.env.example` のデフォルトパスワードは使用しない
   - デプロイ前に必ず変更

4. **HTTPS接続を使用**
   - 本番環境では必ずHTTPSを使用
   - Vercelは自動的にHTTPSを提供

---

## トラブルシューティング

### ❌ 問題: 「アクセス権限がありません」と表示される

**原因と解決策:**

1. **ウォレットがコントラクトオーナーではない**
   - コントラクトオーナーのウォレットアドレスを確認
   - MetaMaskで正しいアカウントに切り替え

2. **ネットワークが間違っている**
   - Polygon Mainnet (Chain ID: 137) または Amoy Testnet (Chain ID: 80002) に接続
   - MetaMaskでネットワークを切り替え

3. **RPC接続エラー**
   - MetaMaskの設定を確認
   - 別のRPCエンドポイントを試す
   - ページをリロード

### ❌ 問題: パスワード入力後に戻される

**原因:**

- セッションストレージがクリアされた
- ブラウザのプライベートモードを使用している

**解決策:**

1. 通常のブラウザモードでアクセス
2. パスワードを再入力
3. ページをリロードせずに操作

### ❌ 問題: ショップ登録に失敗する

**エラーメッセージ別の対処法:**

#### "ショップIDが既に使用されています"
- 別のショップIDを使用してください
- ショップ一覧で既存のIDを確認

#### "insufficient funds for gas"
- ウォレットにPOLが不足しています
- 0.01 POL以上を準備してください

#### "user rejected transaction"
- MetaMaskで「拒否」を押してしまった
- もう一度登録を試み、「確認」をクリック

#### "execution reverted"
- スマートコントラクトエラー
- ガス不足、または無効なパラメータの可能性
- 入力内容を確認してください

### ❌ 問題: 登録したショップが表示されない

**確認事項:**

1. トランザクションが完了しているか Polygonscan で確認
2. ページをリロード（F5キー）
3. ブラウザのキャッシュをクリア

---

## FAQ

### Q1: ショップIDは後から変更できますか?

A: いいえ、ショップIDはスマートコントラクト上で不変です。登録後の変更はできません。

### Q2: 複数のショップに同じオーナーアドレスを設定できますか?

A: はい、1つのウォレットアドレスで複数のショップを管理できます。

### Q3: ショップを削除できますか?

A: 現在のバージョンでは、ショップの完全削除はできません。ショップを無効化する機能は今後追加予定です。

### Q4: パスワードを忘れた場合どうすればいいですか?

A: `.env` ファイルまたはVercelの環境変数を確認してください。変更も可能です。

### Q5: ショップオーナーがSBTを発行できない

**確認事項:**

1. ショップIDが正しく登録されているか
2. ウォレットアドレスが完全一致しているか（大文字小文字含む）
3. 正しいネットワークに接続しているか
4. コントラクトが正しくデプロイされているか

---

## 関連ドキュメント

- [README.md](./README.md) - プロジェクト概要
- [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md) - デプロイメントガイド
- [SBT_ISSUANCE_GUIDE.md](./docs/SBT_ISSUANCE_GUIDE.md) - SBT発行ガイド
- [SECURITY_DEPLOYMENT_GUIDE.md](./SECURITY_DEPLOYMENT_GUIDE.md) - セキュリティガイド

---

## サポート

問題が解決しない場合は、以下の情報とともにお問い合わせください:

- エラーメッセージの全文
- ウォレットアドレス
- 使用しているネットワーク（Mainnet/Testnet）
- トランザクションハッシュ（該当する場合）
- ブラウザとOSのバージョン
