# SBT JPYC Pay - PWA完全対応ガイド

## 📱 PWA機能概要

このアプリは **Progressive Web App (PWA)** として完全に対応されており、オフラインテンプレート管理とオンラインSBT登録が可能です。

### ✨ 主な特徴

- **🗺️ ハイブリッド機能**: オフラインテンプレート管理 + オンラインSBT登録
- **💾 画像ローカル保存**: アップロード画像を完全にブラウザ内保存
- **📤 データエクスポート/インポート**: 他のユーザーとデータ共有可能
- **📱 アプリライク**: ホーム画面への追加・スタンドアロン動作
- **🔐 セキュア**: 秘密鍵・APIキーはローカル設定で管理

> **⚠️ 重要**: SBTのブロックチェーン登録には**サーバー設定**と**インターネット接続**が必要です。
>
> - 🌐 **オンライン機能**: SBT発行・ブロックチェーン書き込み・IPFSアップロード
> - 🗺️ **オフライン機能**: テンプレート作成・編集・管理・統計表示

---

## 🚀 使用開始方法

> **⚠️ 重要な前提**: SBTのブロックチェーン登録にはサーバー設定とインターネット接続が必要です

### 🏢 実用的な利用ケース

- **🏆 推奨**: 店舗・企業単位でのサーバー環境構築
- **🗺️ メリット**: 組織全体でのPinata API管理、セキュリティ向上
- **💼 コスト**: Pinata API料金を組織全体で管理可能

### 1. リポジトリの取得・セットアップ

```bash
git clone https://github.com/miracle777/SBT-JPYC-Pay.git
cd SBT-JPYC-Pay
npm install
npm run dev
```

### 2. ローカル設定

アプリ内の「設定」画面で以下を設定：
- **Pinata API Key**: IPFS画像アップロード用
- **Pinata Secret Key**: IPFS認証用
- **Pinata JWT**: 高度な機能用（オプション）

> 💡 **セキュリティ**: これらの設定はブラウザのローカルストレージに保存され、他のユーザーには共有されません

---

## 📋 機能一覧

### オフライン機能（サーバー不要）

✅ **テンプレート管理**
- SBTテンプレート作成・編集・削除
- 画像アップロード・表示・管理（ローカル保存）
- データエクスポート（JSONダウンロード）
- データインポート（JSONアップロード）
- 統計・分析表示
- UI操作全般

### オンライン機能（サーバー・インターネット接続必要）

🌐 **SBTブロックチェーン登録**
- SBT発行（ブロックチェーンへの書き込み）
- IPFS画像アップロード（Pinata API）
- ウォレット接続（MetaMask）
- トランザクション確認・Explorer表示
- QRコード決済トランザクション監視

### ⚠️ PWAでのウォレット接続制限

**パソコンでのPWA利用時の注意点:**

1. **MetaMask接続制限**: PWAアプリは独立したコンテキストで動作するため、ブラウザのMetaMask拡張機能に直接アクセスできません

2. **残高表示不可**: ウォレット接続ができないため、POL残高やガス代の表示もできません

3. **推奨解決策**:
   - **ブラウザ版を使用**: ウォレット接続が必要な場合は、PWA内のボタンからブラウザ版を開く
   - **ハイブリッド利用**: テンプレート管理はPWA、SBT発行はブラウザ版で使い分ける

4. **自動案内**: アプリが PWA 環境を検出すると、ウォレット接続時に自動的にブラウザ版への案内を表示

**モバイルでの対応状況:**
- **現在**: 同様の制限あり
- **将来**: WalletConnect対応で改善予定

> **🏢 実用的な運用には**: 店舗や企業単位でサーバー設定を含めた環境構築が推奨されます。

---

## 💾 データ管理

### エクスポート機能
1. **SBT管理画面** → **データ管理ボタン**
2. **データをエクスポート** をクリック
3. `sbt-jpyc-pay-export-YYYY-MM-DD.json` ファイルがダウンロード

**含まれるデータ:**
- すべてのSBTテンプレート（ショップID含む）
- 発行済みSBT履歴
- アップロード画像（Base64形式）
- メタデータ・設定情報

### インポート機能
1. **データ管理** → **データをインポート**
2. エクスポートしたJSONファイルを選択
3. **データをインポート** で復元完了

> ⚠️ **注意**: インポート時は既存データを上書きします

---

## 👥 複数人での使用方法

> **⚠️ 注意**: SBTのブロックチェーン登録にはオンライン環境が必要です

### パターン1: 共有エクスポートファイル（テンプレートのみ）

1. **管理者**がテンプレートを作成・設定（オフライン）
2. **データエクスポート**でJSONファイル作成（オフライン）
3. 他のユーザーに**JSONファイルを配布**
4. 各ユーザーは**インポート**で同じ環境を構築（オフライン）
5. **SBT発行時のみ**個別にオンライン環境が必要

### パターン2: リポジトリベース配布（推奨）

1. **GitHub/GitLabにフォーク**またはプライベート複製
2. 各店舗・組織で**独自のセットアップ**
3. **設定画面で個別のPinata API設定**
4. 必要に応じて**カスタマイズ・ブランディング**
5. **サーバー環境へデプロイ**（Vercel, Netlify, AWS等）

> 🏆 **推奨理由**: パターン2はサーバー環境でのSBT白行がスムーズで、組織管理が容易です

---

## 🔧 技術詳細

### IndexedDB構造（バージョン2.0）
```javascript
// テンプレート保存
{
  id: "template-xxxxx",
  shopId: 1234,
  name: "コーヒーカード", 
  imageUrl: "data:image/jpeg;base64,xxxxx", // Base64画像
  // ... 他フィールド
}

// 画像保存（独立ストア）
{
  id: "image-xxxxx",
  templateId: "template-xxxxx",
  fileName: "coffee.jpg",
  base64Data: "data:image/jpeg;base64,xxxxx",
  size: 234567
}
```

### PWA Service Worker
- **キャッシュ戦略**: CacheFirst（画像）、NetworkFirst（API）
- **オフライン対応**: 静的アセット完全キャッシュ
- **更新通知**: 新バージョン自動検出・リロード促進

### セキュリティ考慮事項
- **APIキー管理**: ローカルストレージ（暗号化なし）
- **ブロックチェーン**: 公開ネットワーク使用
- **推奨**: プライベート環境での運用

---

## 📱 PWAインストール

### デスクトップ（Chrome/Edge）
1. アドレスバーの **インストール** アイコンをクリック
2. **「インストール」** を選択
3. デスクトップアプリとして起動可能

### モバイル（Android）
1. メニュー → **「ホーム画面に追加」**
2. アプリ名を確認して **「追加」**
3. ホーム画面のアイコンから起動

### モバイル（iOS Safari）
1. 共有ボタン → **「ホーム画面に追加」**
2. アプリ名を確認して **「追加」**
3. ホーム画面のアイコンから起動

---

## 🔒 セキュリティ・配布ガイドライン

### 推奨配布方法
1. **GitHub公開リポジトリ**: ソースコード配布
2. **プライベートセットアップ**: 各組織で個別構築
3. **設定分離**: APIキー・秘密情報は設定画面で管理
4. **Webアプリ非公開**: 公開URLでの配布は避ける

### セキュリティベストプラクティス
- 🔐 **Pinata APIキー**: 書き込み専用権限に制限
- 🔐 **MetaMask**: 必要最小限の権限のみ許可  
- 🔐 **ブロックチェーン**: テストネット使用を推奨
- 🔐 **データ暗号化**: 機密性高い場合は独自暗号化実装

---

## 🐛 トラブルシューティング

### よくある問題

**Q: 画像が表示されない**
- A: ブラウザのStorageをクリア後、再インポート

**Q: SBT発行が失敗する**
- A: ウォレット接続・ネットワーク設定・ガス代残高を確認

**Q: PWAがインストールできない**
- A: HTTPS環境であること、Manifest.jsonの設定を確認

**Q: データエクスポートが大きすぎる**
- A: 画像数を減らすか、複数回に分けてエクスポート

### デバッグ情報確認
```javascript
// ブラウザ開発者ツールのコンソールで
localStorage.getItem('used-shop-ids'); // ショップID一覧
await sbtStorage.getAllImages(); // 保存済み画像一覧
await sbtStorage.exportData(); // 現在のデータ状況
```

---

## 📄 ライセンス・利用規約

- **MIT License**: 商用・非商用問わず自由利用可能
- **免責事項**: ブロックチェーン操作は自己責任
- **サポート**: GitHubのIssueで問題報告歓迎

---

## 🤝 コントリビューション

改善・機能追加は大歓迎です！

1. Fork this repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)  
5. Open a Pull Request

---

## 📞 サポート・連絡先

- **GitHub Issues**: [https://github.com/miracle777/SBT-JPYC-Pay/issues](https://github.com/miracle777/SBT-JPYC-Pay/issues)
- **Documentation**: このファイルとREADME.md
- **License**: MIT License

---

*Last updated: 2025年11月16日*
*Version: 2.0.0 (PWA Full Support)*